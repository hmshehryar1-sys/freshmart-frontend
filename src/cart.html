<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FreshMart - Cart</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'Poppins', sans-serif;
      background-color: #f5f5f5;
      color: #333;
    }
    nav {
      background-color: #009688;
      padding: 15px 30px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      color: white;
    }
    nav h1 { font-size: 1.8rem; }
    nav ul {
      list-style: none;
      display: flex;
      gap: 25px;
      flex-wrap: wrap;
    }
    nav ul li a {
      color: white;
      text-decoration: none;
      font-weight: 500;
      transition: 0.3s;
    }
    nav ul li a:hover {
      text-decoration: underline;
    }

    .container {
      max-width: 1000px;
      margin: 40px auto;
      background: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }
    h2 {
      text-align: center;
      margin-bottom: 20px;
      color: #00796B;
    }
    table {
      width: 100%;
      border-collapse: collapse;
    }
    table th, table td {
      padding: 10px;
      text-align: center;
      border-bottom: 1px solid #ddd;
    }
    table img {
      height: 60px;
    }
    .qty-btn {
      padding: 4px 10px;
      margin: 0 5px;
      background-color: #009688;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    .qty-btn:hover {
      background-color: #004D40;
    }
    .remove-btn {
      background-color: #e74c3c;
      color: white;
      padding: 5px 10px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    .total-section {
      text-align: right;
      margin-top: 20px;
    }
    .payment-options {
      margin-top: 30px;
      font-size: 1rem;
    }
    .payment-options label {
      margin-right: 20px;
    }
    .instructions {
      background-color: #e0f2f1;
      padding: 15px;
      margin-top: 15px;
      border-radius: 8px;
    }
    .qr-img {
      height: 120px;
      margin: 10px 0;
    }
    .checkout-btn {
      display: block;
      margin: 30px auto 0;
      background-color: #009688;
      color: white;
      border: none;
      padding: 12px 30px;
      font-size: 1rem;
      border-radius: 6px;
      cursor: pointer;
    }
    .checkout-btn:hover {
      background-color: #004D40;
    }
    .delivery {
      margin-top: 30px;
    }
    .delivery input, .delivery textarea {
      width: 100%;
      margin-top: 10px;
      padding: 10px;
      font-size: 1rem;
      border: 1px solid #ccc;
      border-radius: 6px;
    }
    footer {
      background-color: #333;
      color: white;
      text-align: center;
      padding: 20px;
      margin-top: 40px;
    }
  </style>
</head>
<body>

  <nav>
    <h1>FreshMart</h1>
    <ul>
      <li><a href="index.html">Home</a></li>
      <li><a href="products.html">Products</a></li>
      <li><a href="cart.html">Cart</a></li>
      <li><a href="contact.html">Contact</a></li>
    </ul>
  </nav>

  <div class="container">
    <h2>Your Shopping Cart</h2>
    <table id="cartTable">
      <thead>
        <tr>
          <th>Image</th>
          <th>Name</th>
          <th>Price</th>
          <th>Quantity</th>
          <th>Subtotal</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <div class="total-section">
      <h3 id="grandTotal">Grand Total: Rs. 0</h3>
    </div>

    <div class="delivery">
      <h3>Delivery Details</h3>
      <input type="text" id="fullName" placeholder="Full Name" required>
      <input type="text" id="phone" placeholder="Phone Number" required>
      <textarea id="address" placeholder="Complete Delivery Address" rows="3" required></textarea>
    </div>

    <div class="payment-options">
      <h3>Payment Options:</h3>
      <label><input type="radio" name="payment" value="cod"> Cash on Delivery</label>
      <label><input type="radio" name="payment" value="easypaisa"> Easypaisa</label>


      <div class="instructions" id="paymentInstructions" style="display:none;">
        <p><strong>Scan & Pay via QR Code:</strong></p>
        <img src="qr-placeholder.jpg" alt="QR Code" class="qr-img">
        <p>Account: 0331-4254296<br> Account Title: FreshMart Pvt Ltd</p>
      </div>
    </div>

    <button class="checkout-btn" onclick="placeOrder()">Place Order</button>
  </div>

  <footer>
    &copy; 2025 FreshMart Departmental Store. All rights reserved.
  </footer>

  <script src="js/api.js"></script>
  <script src="js/auth.js"></script>
  <script>
    // Check authentication
    if (!isAuthenticated()) {
      alert("Please login to view your cart");
      window.location.href = "user-login.html";
    }

    let cart = [];

    async function loadCart() {
      try {
        const response = await cartAPI.get();
        cart = response.data || [];
        renderCart();
      } catch (error) {
        console.error("Error loading cart:", error);
        alert("Error loading cart. Please try again.");
      }
    }

    function renderCart() {
      const tbody = document.querySelector("#cartTable tbody");
      tbody.innerHTML = "";
      let total = 0;

      cart.forEach((item, index) => {
        const subtotal = item.price * item.quantity;
        total += subtotal;
        const row = document.createElement("tr");
        row.innerHTML = `
          <td><img src="${item.image}" alt="${item.name}"></td>
          <td>${item.name}</td>
          <td>Rs. ${item.price}</td>
          <td>
            <button class="qty-btn" onclick="updateQty('${item.productId}', ${item.quantity - 1})">-</button>
            ${item.quantity}
            <button class="qty-btn" onclick="updateQty('${item.productId}', ${item.quantity + 1})">+</button>
          </td>
          <td>Rs. ${subtotal}</td>
          <td><button class="remove-btn" onclick="removeItem('${item.productId}')">Remove</button></td>
        `;
        tbody.appendChild(row);
      });

      document.getElementById("grandTotal").innerText = `Grand Total: Rs. ${total}`;
    }

    async function updateQty(productId, newQuantity) {
      try {
        if (newQuantity <= 0) {
          await cartAPI.remove(productId);
        } else {
          await cartAPI.update(productId, newQuantity);
        }
        await loadCart();
      } catch (error) {
        console.error("Error updating cart:", error);
        alert("Error updating cart. Please try again.");
      }
    }

    async function removeItem(productId) {
      try {
        await cartAPI.remove(productId);
        await loadCart();
      } catch (error) {
        console.error("Error removing item:", error);
        alert("Error removing item. Please try again.");
      }
    }

    document.querySelectorAll("input[name='payment']").forEach(radio => {
      radio.addEventListener("change", () => {
        const value = document.querySelector("input[name='payment']:checked").value;
        const instructions = document.getElementById("paymentInstructions");
        if (value === "jazzcash" || value === "easypaisa" || value === "bank") {
          instructions.style.display = "block";
        } else {
          instructions.style.display = "none";
        }
      });
    });

    async function placeOrder() {
      const fullName = document.getElementById("fullName").value.trim();
      const phone = document.getElementById("phone").value.trim();
      const address = document.getElementById("address").value.trim();
      const paymentMethod = document.querySelector("input[name='payment']:checked");

      if (!fullName || !phone || !address) {
        alert("Please fill in all delivery details.");
        return;
      }

      if (!paymentMethod) {
        alert("Please select a payment method.");
        return;
      }

      if (cart.length === 0) {
        alert("Your cart is empty!");
        return;
      }

      try {
        const orderData = {
          items: cart,
          deliveryDetails: {
            fullName,
            phone,
            address
          },
          paymentMethod: paymentMethod.value
        };

        const response = await ordersAPI.create(orderData);
        
        if (response.success) {
          await cartAPI.clear();
          alert("Order placed successfully!");
          window.location.href = "thankyou.html";
        }
      } catch (error) {
        console.error("Error placing order:", error);
        alert("Error placing order: " + error.message);
      }
    }

    // Load cart on page load
    loadCart();
  </script>

</body>
</html>





