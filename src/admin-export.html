<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Export Data - FreshMart Admin</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Poppins', sans-serif;
      display: flex;
      background-color: #f9f9f9;
      min-height: 100vh;
    }

    .sidebar {
      width: 240px;
      background-color: #004D40;
      color: white;
      padding: 30px 20px;
      display: flex;
      flex-direction: column;
    }
    .sidebar h2 {
      margin-bottom: 30px;
      font-size: 1.6rem;
      text-align: center;
    }
    .sidebar a {
      color: white;
      text-decoration: none;
      padding: 12px 15px;
      border-radius: 6px;
      margin-bottom: 10px;
      display: block;
      transition: background 0.3s;
    }
    .sidebar a:hover {
      background-color: #00796B;
    }

    .main {
      flex: 1;
      padding: 30px;
    }

    .main h1 {
      margin-bottom: 25px;
      color: #004D40;
    }

    .export-section {
      display: flex;
      gap: 20px;
      flex-wrap: wrap;
    }

    .export-box {
      background: white;
      padding: 20px;
      border-radius: 10px;
      width: 300px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }

    .export-box h3 {
      margin-bottom: 15px;
      color: #00796B;
    }

    .btn {
      background-color: #009688;
      color: white;
      padding: 10px 18px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      margin-right: 10px;
      margin-top: 10px;
      font-weight: bold;
      transition: background 0.3s;
    }

    .btn:hover {
      background-color: #004D40;
    }
  </style>
</head>
<body>

  <!-- Sidebar -->
  <aside class="sidebar">
    <h2>FreshMart Admin</h2>
    <a href="admin-dashboard.html">üè† Dashboard</a>
    <a href="admin-orders.html">üì¶ Manage Orders</a>
    <a href="admin-users.html">üë• Manage Users</a>
    <a href="admin-profile.html">üßë‚Äçüíº Profile Settings</a>
    <a href="admin-export.html">üìÑ Export Data</a>
    <a href="#" onclick="logout()">üö™ Logout</a>
  </aside>

  <!-- Main -->
  <main class="main">
    <h1>Export Users & Orders</h1>

    <div class="export-section">
      <!-- Export Users -->
      <div class="export-box">
        <h3>Users Data</h3>
        <button class="btn" onclick="exportUsers('excel')">Export to Excel</button>
        <button class="btn" onclick="exportUsers('pdf')">Export to PDF</button>
      </div>

      <!-- Export Orders -->
      <div class="export-box">
        <h3>Orders Data</h3>
        <button class="btn" onclick="exportOrders('excel')">Export to Excel</button>
        <button class="btn" onclick="exportOrders('pdf')">Export to PDF</button>
      </div>
    </div>
  </main>

  <script src="js/api.js"></script>
  <script src="js/auth.js"></script>
  <script>
    if (!requireAdmin()) {
      return;
    }

    async function exportUsers(type) {
      try {
        const response = await usersAPI.getAll();
        const users = response.data || [];
        const userData = users.map((u, i) => ({
          ID: u._id.slice(-6),
          Name: u.name,
          Email: u.email,
          Role: u.role,
          Phone: u.phone || 'N/A',
          Address: u.address || 'N/A'
        }));

        if (type === 'excel') {
          const ws = XLSX.utils.json_to_sheet(userData);
          const wb = XLSX.utils.book_new();
          XLSX.utils.book_append_sheet(wb, ws, "Users");
          XLSX.writeFile(wb, "FreshMart_Users.xlsx");
        } else if (type === 'pdf') {
          const { jsPDF } = window.jspdf;
          const doc = new jsPDF();
          doc.text("FreshMart Users", 20, 20);
          userData.forEach((user, i) => {
            doc.text(`${user.ID} | ${user.Name} | ${user.Email} | ${user.Role}`, 20, 30 + i * 10);
          });
          doc.save("FreshMart_Users.pdf");
        }
      } catch (error) {
        console.error("Error exporting users:", error);
        alert("Error exporting users: " + error.message);
      }
    }

    async function exportOrders(type) {
      try {
        const response = await ordersAPI.getAll();
        const orders = response.data || [];
        const orderData = orders.map((o, i) => ({
          OrderID: o._id.slice(-6),
          User: o.user ? (o.user.name || o.user.email) : 'N/A',
          Total: `Rs. ${o.totalAmount}`,
          Date: new Date(o.createdAt).toLocaleDateString(),
          Status: o.status,
          PaymentMethod: o.paymentMethod
        }));

        if (type === 'excel') {
          const ws = XLSX.utils.json_to_sheet(orderData);
          const wb = XLSX.utils.book_new();
          XLSX.utils.book_append_sheet(wb, ws, "Orders");
          XLSX.writeFile(wb, "FreshMart_Orders.xlsx");
        } else if (type === 'pdf') {
          const { jsPDF } = window.jspdf;
          const doc = new jsPDF();
          doc.text("FreshMart Orders", 20, 20);
          orderData.forEach((order, i) => {
            doc.text(`${order.OrderID} | ${order.User} | ${order.Total} | ${order.Date}`, 20, 30 + i * 10);
          });
          doc.save("FreshMart_Orders.pdf");
        }
      } catch (error) {
        console.error("Error exporting orders:", error);
        alert("Error exporting orders: " + error.message);
      }
    }
  </script>

</body>
</html>
